export default async (req)=>{if(req.method!=='POST')return new Response(JSON.stringify({error:'Method not allowed'}),{status:405});const OPENAI_API_KEY=process.env.OPENAI_API_KEY;if(!OPENAI_API_KEY)return new Response(JSON.stringify({error:'Missing OPENAI_API_KEY'}),{status:500});let body;try{body=await req.json();}catch{return new Response(JSON.stringify({error:'Invalid JSON'}),{status:400});}const {messages=[],temperature=0.6,model='gpt-4o-mini'}=body;const systemPrompt=`Eres un agente de soporte experto en IMPRESIÓN 3D CON FILAMENTO (FDM/FFF).
- Responde en español neutral, tono profesional cercano.
- Sé práctico y accionable. Enfócate en PLA y PETG. Incluye parámetros (altura de capa, temperaturas boquilla/cama, retracciones, velocidades, ventilación, boquilla) y calibraciones (flow, e-steps, PID, nivelado).
- Troubleshooting: warping, stringing, under/over-extrusion, elephant foot, adhesión, soportes, infill, orientación, tolerancias y postpro.
- No inventes especificaciones. Si faltan datos, pide impresora, material/marca, temps, altura capa, velocidad, ventilador, boquilla y foto si aplica.`;const input=[{role:'system',content:systemPrompt},...messages.map(m=>({role:m.role||'user',content:String(m.content||'')}))];try{const r=await fetch('https://api.openai.com/v1/responses',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${OPENAI_API_KEY}`},body:JSON.stringify({model,input,temperature})});const data=await r.json();if(!r.ok)return new Response(JSON.stringify({error:'Upstream',detail:data}),{status:502});const reply=data.output_text??(data.output?.[0]?.content?.[0]?.text??'');return new Response(JSON.stringify({reply}),{headers:{'content-type':'application/json'}});}catch(e){return new Response(JSON.stringify({error:String(e)}),{status:500});}};